// lib/services/cardapio_service.dart
// Atualizado para o novo backend FastAPI

import 'dart:convert';
import 'dart:async';
import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;
import '../models/cardapio_models.dart';

class CardapioService {
  // =========================================================================
  // CONFIGURA√á√ÉO DO BACKEND
  // =========================================================================

  /// URL base do backend - AJUSTE CONFORME SEU AMBIENTE
  static const String baseUrl = 'http://192.168.3.150:8000/api/v1';

  /// Timeout padr√£o para requisi√ß√µes
  static const Duration timeout = Duration(seconds: 30);

  /// Headers padr√£o
  static Map<String, String> get _headers => {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
  };

  /// Getter p√∫blico para a URL base (usado para construir URLs de imagem)
  static String get serverUrl => baseUrl;

  // =========================================================================
  // CARD√ÅPIO COMPLETO (Principal - usado pela tela)
  // =========================================================================

  /// Busca o card√°pio completo com todas as se√ß√µes, imagens e produtos
  /// Endpoint: GET /cardapios/{cardapio_grid}/completo
  static Future<CardapioCompletoResponse?> obterCardapioCompleto(
    int cardapioGrid,
  ) async {
    try {
      final uri = Uri.parse('$baseUrl/cardapios/$cardapioGrid/completo');

      if (kDebugMode) {
        debugPrint('üì° [CardapioService] Buscando card√°pio completo: $uri');
      }

      final response = await http.get(uri, headers: _headers).timeout(timeout);

      if (response.statusCode == 200) {
        // Decodifica UTF-8 para caracteres especiais
        final bodyString = utf8.decode(response.bodyBytes);
        final data = json.decode(bodyString);

        if (kDebugMode) {
          final cardapioNome = data['cardapio']?['nome'] ?? 'N/A';
          final qtdSecoes = (data['secoes'] as List?)?.length ?? 0;
          debugPrint(
            '‚úÖ [CardapioService] Card√°pio: $cardapioNome ($qtdSecoes se√ß√µes)',
          );
        }

        return CardapioCompletoResponse.fromJson(data);
      } else if (response.statusCode == 404) {
        debugPrint(
          '‚ö†Ô∏è [CardapioService] Card√°pio $cardapioGrid n√£o encontrado',
        );
        return null;
      } else {
        debugPrint(
          '‚ùå [CardapioService] Erro: ${response.statusCode} - ${response.body}',
        );
        return null;
      }
    } on TimeoutException {
      debugPrint('‚ùå [CardapioService] Timeout ao buscar card√°pio');
      return null;
    } catch (e) {
      debugPrint('‚ùå [CardapioService] Erro de conex√£o: $e');
      return null;
    }
  }

  // =========================================================================
  // ENDPOINTS INDIVIDUAIS (para uso espec√≠fico)
  // =========================================================================

  /// Lista todos os card√°pios dispon√≠veis
  /// Endpoint: GET /cardapios
  static Future<List<Cardapio>> listarCardapios({
    int skip = 0,
    int limit = 100,
  }) async {
    try {
      final uri = Uri.parse('$baseUrl/cardapios?skip=$skip&limit=$limit');

      final response = await http.get(uri, headers: _headers).timeout(timeout);

      if (response.statusCode == 200) {
        final bodyString = utf8.decode(response.bodyBytes);
        final data = json.decode(bodyString);
        final items = data['items'] as List? ?? [];

        return items.map((e) => Cardapio.fromJson(e)).toList();
      }
      return [];
    } catch (e) {
      debugPrint('‚ùå [CardapioService] Erro ao listar card√°pios: $e');
      return [];
    }
  }

  /// Busca um card√°pio por grid
  /// Endpoint: GET /cardapios/{cardapio_grid}
  static Future<Cardapio?> obterCardapio(int cardapioGrid) async {
    try {
      final uri = Uri.parse('$baseUrl/cardapios/$cardapioGrid');

      final response = await http.get(uri, headers: _headers).timeout(timeout);

      if (response.statusCode == 200) {
        final bodyString = utf8.decode(response.bodyBytes);
        final data = json.decode(bodyString);
        return Cardapio.fromJson(data);
      }
      return null;
    } catch (e) {
      debugPrint('‚ùå [CardapioService] Erro ao obter card√°pio: $e');
      return null;
    }
  }

  /// Lista se√ß√µes de um card√°pio
  /// Endpoint: GET /cardapios/codigo/{cardapio_grid}/secoes
  static Future<List<CardapioSecao>> listarSecoes(int cardapioGrid) async {
    try {
      final uri = Uri.parse('$baseUrl/cardapios/codigo/$cardapioGrid/secoes');

      final response = await http.get(uri, headers: _headers).timeout(timeout);

      if (response.statusCode == 200) {
        final bodyString = utf8.decode(response.bodyBytes);
        final data = json.decode(bodyString) as List;
        return data.map((e) => CardapioSecao.fromJson(e)).toList();
      }
      return [];
    } catch (e) {
      debugPrint('‚ùå [CardapioService] Erro ao listar se√ß√µes: $e');
      return [];
    }
  }

  // =========================================================================
  // HELPERS PARA IMAGENS
  // =========================================================================

  /// Retorna a URL da imagem de uma se√ß√£o
  static String getImagemSecaoUrl(int secaoGrid, {String ext = 'jpeg'}) {
    return '$baseUrl/static/img/cardapio/secao_$secaoGrid.$ext';
  }

  /// Retorna a URL da imagem de um produto
  static String getImagemProdutoUrl(int produtoGrid, {String ext = 'jpeg'}) {
    return '$baseUrl/static/img/produtos/produto_$produtoGrid.$ext';
  }

  // =========================================================================
  // HEALTH CHECK
  // =========================================================================

  /// Verifica se o servidor est√° online
  static Future<bool> checkHealth() async {
    try {
      final uri = Uri.parse('$baseUrl/health');
      final response = await http.get(uri).timeout(const Duration(seconds: 5));

      return response.statusCode == 200;
    } catch (e) {
      debugPrint('‚ùå [CardapioService] Health check falhou: $e');
      return false;
    }
  }

  /// Debug de conex√£o
  static Future<void> debugConexao() async {
    debugPrint('üêõ === DEBUG CARDAPIO SERVICE ===');
    debugPrint('üåê Base URL: $baseUrl');

    try {
      // Health check
      final health = await checkHealth();
      debugPrint('üè• Health: ${health ? "OK" : "FALHOU"}');

      // Lista card√°pios
      final cardapios = await listarCardapios(limit: 3);
      debugPrint('üìã Card√°pios encontrados: ${cardapios.length}');
      for (final c in cardapios) {
        debugPrint('   - [${c.grid}] ${c.nome}');
      }
    } catch (e) {
      debugPrint('‚ùå Erro no debug: $e');
    }

    debugPrint('üêõ === FIM DEBUG ===');
  }
}
